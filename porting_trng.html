<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ASCON Suite: Porting the TRNG to new platforms</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ASCON Suite
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Porting the TRNG to new platforms </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#trng_backends">Backends</a></li>
<li class="level1"><a href="#trng_porting">Porting to a new platform</a></li>
<li class="level1"><a href="#trng_escape_hatch">Escape hatch</a></li>
</ul>
</div>
<div class="textblock"><p>Applications should use the <a class="el" href="random_8h.html">PRNG API</a> to get random data. In particular, the <a class="el" href="random_8h.html#a38c7ab7e9a904f53aed0446661d43646" title="Gets a block of random data from the system. ">ascon_random()</a> function provides a quick method to get random data that has a uniform spread of entropy and has had any vendor watermarks or bias removed.</p>
<p>The functions in the backend TRNG API are how the library harvests entropy from the system, but that entropy should not be used directly by applications. It may be of poor quality or the CPU vendor may be untrustworthy.</p>
<p>The rest of this page is only of interest to people who want to port the library to a new microcontroller that has a built-in random number generator peripheral.</p>
<h1><a class="anchor" id="trng_backends"></a>
Backends</h1>
<p>The library contains several TRNG backends for interfacing to the system's random number generator in the <code>src/random</code> subdirectory:</p>
<table class="doxtable">
<tr>
<td><b>Backend</b></td><td><b>Platforms</b>&lt;/td </td></tr>
<tr>
<td>dev-random</td><td>Linux, FreeBSD, OpenBSD, and other Unix-like systems with a /dev/urandom or /dev/random device. </td></tr>
<tr>
<td>due</td><td>Arudino Due / SAM3X8E </td></tr>
<tr>
<td>esp</td><td>ESP8266 and ESP32 modules </td></tr>
<tr>
<td>none</td><td>Default if the platform is not recognised </td></tr>
<tr>
<td>stm32</td><td>STM32 platforms with the HAL_RNG_GenerateRandomNumber() function </td></tr>
<tr>
<td>windows</td><td>Windows systems using the CryptGenRandom() function </td></tr>
</table>
<p>The file <a class="el" href="ascon-select-trng_8h_source.html">ascon-select-trng.h</a> contains <code>#ifdef</code>'s to select the specific backend. You will need to modify this file when adding a new backend.</p>
<p>The "dev-random" backend will use the <code>getrandom()</code> or <code>genentropy()</code> functions instead of /dev/urandom, if one of those functions is present on the system.</p>
<p>On Arduino systems, the "none" backend will harvest a very small amount of entropy from the <code>millis()</code> and <code>micros()</code> functions but the result will not be very good against a determined adversary.</p>
<p>Patches welcome to add support for TRNG peripherals on other microcontrollers.</p>
<h1><a class="anchor" id="trng_porting"></a>
Porting to a new platform</h1>
<p>There are two separate TRNG API's declared in <a class="el" href="ascon-trng_8h.html">ascon-trng.h</a>.</p>
<p>The first API is the function <a class="el" href="ascon-trng_8h.html#a1f56ed5cff00978e75f3061fa4535621" title="Generates a buffer of bytes from the system TRNG source. ">ascon_trng_generate()</a> which generates a buffer of random bytes and returns them to the caller. This is called from the <a class="el" href="random_8h.html">PRNG API</a> in various places to request 256 bits of random data to initialize or re-seed the PRNG.</p>
<p>The following example is from the "esp" backend, which uses the Espressif SDK function <code>esp_random()</code> to acquire 32-bit random values:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="ascon-trng_8h.html#a1f56ed5cff00978e75f3061fa4535621">ascon_trng_generate</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out, <span class="keywordtype">size_t</span> outlen)</div>
<div class="line">{</div>
<div class="line">    uint32_t x;</div>
<div class="line">    <span class="keywordflow">while</span> (outlen &gt;= <span class="keyword">sizeof</span>(x)) {</div>
<div class="line">        x = esp_random();</div>
<div class="line">        memcpy(out, &amp;x, <span class="keyword">sizeof</span>(x));</div>
<div class="line">        out += <span class="keyword">sizeof</span>(x);</div>
<div class="line">        outlen -= <span class="keyword">sizeof</span>(x);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (outlen &gt; 0) {</div>
<div class="line">        x = esp_random();</div>
<div class="line">        memcpy(out, &amp;x, outlen);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 1; <span class="comment">/* Assume that it works */</span></div>
<div class="line">}</div>
</div><!-- fragment --><p> The <a class="el" href="ascon-trng_8h.html#a1f56ed5cff00978e75f3061fa4535621" title="Generates a buffer of bytes from the system TRNG source. ">ascon_trng_generate()</a> function should return non-zero if the backend judges that the random noise source is good. If the noise source is not present or is inoperable for some reason, the function should return zero. Since it isn't possible to determine if <code>esp_random()</code> is working correctly or not we have to simply assume that it works and return 1.</p>
<p>The second TRNG API defines the functions <a class="el" href="ascon-trng_8h.html#abfa435f9eb6f9c364a131efe5a1cf9b2" title="Initializes the random number source for generating a sequence of masking material at high speed...">ascon_trng_init()</a>, <a class="el" href="ascon-trng_8h.html#ae9cdf0973ca1098e50274490e5575821" title="Frees the random number source and destroys any sensitive material. ">ascon_trng_free()</a>, <a class="el" href="ascon-trng_8h.html#a1f6cd78f3b8b840a53e71616764d0f98" title="Generates a 32-bit random value for masking operations. ">ascon_trng_generate_32()</a>, <a class="el" href="ascon-trng_8h.html#ab1dea3c48686092616b052aef452f946" title="Generates a 64-bit random value for masking operations. ">ascon_trng_generate_64()</a>, and <a class="el" href="ascon-trng_8h.html#ad7ebee9831efe41233f13989e76dfd0a" title="Reseeds the random number source. ">ascon_trng_reseed()</a>. These are used by masked ciphers to generate random masking material at a high data rate.</p>
<p>Whereas <a class="el" href="ascon-trng_8h.html#a1f56ed5cff00978e75f3061fa4535621" title="Generates a buffer of bytes from the system TRNG source. ">ascon_trng_generate()</a> can take its time to generate high-quality random data, <a class="el" href="ascon-trng_8h.html#a1f6cd78f3b8b840a53e71616764d0f98" title="Generates a 32-bit random value for masking operations. ">ascon_trng_generate_32()</a> and <a class="el" href="ascon-trng_8h.html#ab1dea3c48686092616b052aef452f946" title="Generates a 64-bit random value for masking operations. ">ascon_trng_generate_64()</a> must operate as fast as possible. In the case of the "esp" backend, the <code>esp_random()</code> function is as fast as we're going to get:</p>
<div class="fragment"><div class="line">uint32_t <a class="code" href="ascon-trng_8h.html#a1f6cd78f3b8b840a53e71616764d0f98">ascon_trng_generate_32</a>(<a class="code" href="structascon__trng__state__t.html">ascon_trng_state_t</a> *state)</div>
<div class="line">{</div>
<div class="line">    (void)state;</div>
<div class="line">    <span class="keywordflow">return</span> esp_random();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">uint64_t <a class="code" href="ascon-trng_8h.html#ab1dea3c48686092616b052aef452f946">ascon_trng_generate_64</a>(<a class="code" href="structascon__trng__state__t.html">ascon_trng_state_t</a> *state)</div>
<div class="line">{</div>
<div class="line">    (void)state;</div>
<div class="line">    <span class="keywordflow">return</span> ((uint64_t)esp_random()) | (((uint64_t)esp_random()) &lt;&lt; 32);</div>
<div class="line">}</div>
</div><!-- fragment --><p> On x86-64 platforms, the "dev-random" backend uses the "RDRAND" instruction to generate random masking material rapidly. But <a class="el" href="ascon-trng_8h.html#a1f56ed5cff00978e75f3061fa4535621" title="Generates a buffer of bytes from the system TRNG source. ">ascon_trng_generate()</a> takes the safer option of using /dev/urandom instead. While "RDRAND" is good enough for masking, it may not be trustworthly enough for general application use.</p>
<p>On some platforms, the normal random source is too slow for masking. Such backends define <code>ASCON_TRNG_MIXER</code> and implement a simple PRNG based on the ASCON permutation to stretch an initial seed out into an arbitrary amount of masking material. See the "dev-random" and "windows" backends for examples of how to implement a mixer. Or contact the library author for assistance.</p>
<p>On systems that use a mixer, the function <a class="el" href="ascon-trng_8h.html#ad7ebee9831efe41233f13989e76dfd0a" title="Reseeds the random number source. ">ascon_trng_reseed()</a> should request a new seed using the same method as <a class="el" href="ascon-trng_8h.html#a1f56ed5cff00978e75f3061fa4535621" title="Generates a buffer of bytes from the system TRNG source. ">ascon_trng_generate()</a> and mix the new seed into the mixer state. This provides freshness to the random state over time when very large amounts of masking material are being generated. For the "esp", no re-seeding is required (or possible):</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="ascon-trng_8h.html#ad7ebee9831efe41233f13989e76dfd0a">ascon_trng_reseed</a>(<a class="code" href="structascon__trng__state__t.html">ascon_trng_state_t</a> *state)</div>
<div class="line">{</div>
<div class="line">    (void)state;</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --> <h1><a class="anchor" id="trng_escape_hatch"></a>
Escape hatch</h1>
<p>The "none" backend provides two weak functions that allows the application to provide its own noise source if the library was unable to find a suitable backend.</p>
<p>The ascon_trng_get_bytes() function can be overridden by the application to provide custom noise:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ascon_trng_get_bytes(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out, <span class="keywordtype">size_t</span> outlen)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// populate the &quot;out&quot; buffer with &quot;outlen&quot; bytes of noise</span></div>
<div class="line">    ...;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// return 1 to indicate that the noise is good, 0 if the</span></div>
<div class="line">    <span class="comment">// noise source is not available or inoperable.</span></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Normally the "none" backend will not fully trust the data that comes from the application and will still use its own strategy to harvest entropy from system timers in addition to mixing in the application's noise.</p>
<p>If the application is very confident about its noise source, then it can override the ascon_trng_get_bytes_is_good() function to signal that the "none" backend doesn't need to harvest its own entropy:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ascon_trng_get_bytes_is_good(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The escape hatch only works with the "none" backend. The two functions will be ignored if some other backend has been selected. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat May 14 2022 08:17:55 for ASCON Suite by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
