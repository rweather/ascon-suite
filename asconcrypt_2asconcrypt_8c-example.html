<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ASCON Suite: asconcrypt/asconcrypt.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ASCON Suite
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">asconcrypt/asconcrypt.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2022 Southern Storm Software, Pty Ltd.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Permission is hereby granted, free of charge, to any person obtaining a</span></div>
<div class="line"><span class="comment"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span></div>
<div class="line"><span class="comment"> * to deal in the Software without restriction, including without limitation</span></div>
<div class="line"><span class="comment"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span></div>
<div class="line"><span class="comment"> * and/or sell copies of the Software, and to permit persons to whom the</span></div>
<div class="line"><span class="comment"> * Software is furnished to do so, subject to the following conditions:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The above copyright notice and this permission notice shall be included</span></div>
<div class="line"><span class="comment"> * in all copies or substantial portions of the Software.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span></div>
<div class="line"><span class="comment"> * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></div>
<div class="line"><span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span></div>
<div class="line"><span class="comment"> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></div>
<div class="line"><span class="comment"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span></div>
<div class="line"><span class="comment"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span></div>
<div class="line"><span class="comment"> * DEALINGS IN THE SOFTWARE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(HAVE_CONFIG_H)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="aead_8h.html">ascon/aead.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pbkdf2_8h.html">ascon/pbkdf2.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="random_8h.html">ascon/random.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="siv_8h.html">ascon/siv.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="utility_8h.html">ascon/utility.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#if defined(HAVE_GETOPT_H)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#if defined(HAVE_ISATTY)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;fileops.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;readpass.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define ASCON_PBKDF2_ROUNDS 8192</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define ASCON_BUFSIZ        BUFSIZ</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ASCON_PWSIZ         1024</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define ASCON_MAX_FILE_SIZE (1024ULL * 1024ULL * 1024ULL * 1024ULL)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MODE_DECRYPT        0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MODE_ENCRYPT        1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MODE_DETECT         2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MODE_GENERATE       3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> full_password[ASCON_PWSIZ];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> confirm_password[ASCON_PWSIZ];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> temp_filename[ASCON_BUFSIZ];</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *progname);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> password_error(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> generate_password(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyfile);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> read_keyfile(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyfile);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> is_encrypted_filename(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename);</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *strip_suffix(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename);</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *add_suffix(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *suffix);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> encrypt_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *infilename, <span class="keyword">const</span> <span class="keywordtype">char</span> *outfilename);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> decrypt_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *infilename, <span class="keyword">const</span> <span class="keywordtype">char</span> *outfilename);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *progname = argv[0];</div>
<div class="line">    <span class="keywordtype">int</span> opt_mode = MODE_DETECT;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *opt_password = NULL;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *opt_keyfile = NULL;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *opt_output = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> opt, posn;</div>
<div class="line">    <span class="keywordtype">int</span> exit_val = 0;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(HAVE_GETOPT)</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">/* Process the command-line options */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt(argc, argv, <span class="stringliteral">&quot;edp:k:o:g:&quot;</span>)) != -1) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>: opt_mode = MODE_ENCRYPT; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>: opt_mode = MODE_DECRYPT; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>: opt_password = optarg; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;k&#39;</span>: opt_keyfile = optarg; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>: opt_output = optarg; <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;g&#39;</span>:</div>
<div class="line">            opt_mode = MODE_GENERATE;</div>
<div class="line">            opt_keyfile = optarg;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            usage(progname);</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">/* Simple command-line parser for systems without getopt() */</span></div>
<div class="line"><span class="preprocessor">    #define GET_OPTARG(var) \</span></div>
<div class="line"><span class="preprocessor">        do { \</span></div>
<div class="line"><span class="preprocessor">            (var) = NULL; \</span></div>
<div class="line"><span class="preprocessor">            if (opts[0] == &#39;\0&#39;) { \</span></div>
<div class="line"><span class="preprocessor">                if ((optind + 1) &lt; argc) { \</span></div>
<div class="line"><span class="preprocessor">                    (var) = argv[optind + 1]; \</span></div>
<div class="line"><span class="preprocessor">                    ++optind; \</span></div>
<div class="line"><span class="preprocessor">                } else { \</span></div>
<div class="line"><span class="preprocessor">                    error = 1; \</span></div>
<div class="line"><span class="preprocessor">                } \</span></div>
<div class="line"><span class="preprocessor">            } else { \</span></div>
<div class="line"><span class="preprocessor">                (var) = opts; \</span></div>
<div class="line"><span class="preprocessor">                opts = &quot;&quot;; \</span></div>
<div class="line"><span class="preprocessor">            } \</span></div>
<div class="line"><span class="preprocessor">        } while (0)</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordtype">int</span> optind = 1;</div>
<div class="line">    <span class="keywordflow">while</span> (optind &lt; argc &amp;&amp; argv[optind][0] == <span class="charliteral">&#39;-&#39;</span> &amp;&amp;</div>
<div class="line">           argv[optind][1] != <span class="charliteral">&#39;\0&#39;</span>) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *opts = argv[optind] + 1;</div>
<div class="line">        <span class="keywordflow">while</span> ((opt = *opts++) != <span class="charliteral">&#39;\0&#39;</span>) {</div>
<div class="line">            <span class="keywordtype">int</span> error = 0;</div>
<div class="line">            <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>: opt_mode = MODE_ENCRYPT; <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>: opt_mode = MODE_DECRYPT; <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>: GET_OPTARG(opt_password); <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;k&#39;</span>: GET_OPTARG(opt_keyfile); <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>: GET_OPTARG(opt_output); <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;g&#39;</span>:</div>
<div class="line">                opt_mode = MODE_GENERATE;</div>
<div class="line">                GET_OPTARG(opt_keyfile);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">default</span>: error = 1; <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (error) {</div>
<div class="line">                usage(progname);</div>
<div class="line">                <span class="keywordflow">return</span> 1;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        ++optind;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">/* Validate the arguments */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((opt_mode == MODE_GENERATE &amp;&amp; optind &lt; argc) ||</div>
<div class="line">            (opt_mode != MODE_GENERATE &amp;&amp; optind &gt;= argc)) {</div>
<div class="line">        usage(progname);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (opt_mode != MODE_GENERATE) {</div>
<div class="line">        <span class="keywordflow">if</span> (opt_password &amp;&amp; opt_keyfile) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;%s: cannot specify both -p and -k\n&quot;</span>, progname);</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (opt_output &amp;&amp; optind &lt; (argc - 1)) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;%s: only one input file allowed with -o\n&quot;</span>, progname);</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Handle password file generation */</span></div>
<div class="line">    <span class="keywordflow">if</span> (opt_mode == MODE_GENERATE) {</div>
<div class="line">        <span class="keywordflow">if</span> (!generate_password(opt_keyfile))</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Auto-detect encrypt vs decrypt if necessary.  If standard input is</span></div>
<div class="line"><span class="comment">     * supplied, then we default to encrypting it.  It is necessary to</span></div>
<div class="line"><span class="comment">     * specify -d to decrypt standard input. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (opt_mode == MODE_DETECT) {</div>
<div class="line">        <span class="keywordtype">int</span> mixture = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (posn = optind; posn &lt; argc; ++posn) {</div>
<div class="line">            <span class="keywordflow">if</span> (is_encrypted_filename(argv[posn])) {</div>
<div class="line">                <span class="keywordflow">if</span> (opt_mode == MODE_ENCRYPT)</div>
<div class="line">                    mixture = 1;</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    opt_mode = MODE_DECRYPT;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">if</span> (opt_mode == MODE_DECRYPT)</div>
<div class="line">                    mixture = 1;</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    opt_mode = MODE_ENCRYPT;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (mixture) {</div>
<div class="line">            <span class="comment">/* There is a mixture of file types, so bail out */</span></div>
<div class="line">            fprintf(stderr,</div>
<div class="line">                    <span class="stringliteral">&quot;%s: cannot determine direction; specify -e or -d\n&quot;</span>,</div>
<div class="line">                    progname);</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Acquire the password, from the command-line, a key file,</span></div>
<div class="line"><span class="comment">     * or by prompting the user to enter it. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (opt_password) {</div>
<div class="line">        <span class="keywordflow">if</span> (strlen(opt_password) &gt;= <span class="keyword">sizeof</span>(full_password)) {</div>
<div class="line">            password_error(progname);</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line">        strncpy(full_password, opt_password, <span class="keyword">sizeof</span>(full_password));</div>
<div class="line">        full_password[<span class="keyword">sizeof</span>(full_password) - 1] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opt_keyfile) {</div>
<div class="line">        <span class="keywordflow">if</span> (!read_keyfile(opt_keyfile)) {</div>
<div class="line">            <a name="a0"></a><a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(full_password, <span class="keyword">sizeof</span>(full_password));</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordtype">int</span> have_password;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(HAVE_ISATTY)</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">/* Must have a real tty for stdin and stdout to prompt for a password */</span></div>
<div class="line">        <span class="keywordflow">if</span> (!isatty(0) || !isatty(1)) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;%s: cannot prompt for a password without a terminal\n&quot;</span>,</div>
<div class="line">                    progname);</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        <span class="comment">/* If we are encrypting, ask for the password twice to confirm.</span></div>
<div class="line"><span class="comment">         * If we are decrypting, then only ask for the password once. */</span></div>
<div class="line">        have_password = 0;</div>
<div class="line">        <span class="keywordflow">if</span> (opt_mode == MODE_DECRYPT) {</div>
<div class="line">            have_password = read_password</div>
<div class="line">                (<span class="stringliteral">&quot;Password: &quot;</span>, full_password, <span class="keyword">sizeof</span>(full_password));</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            have_password = read_password</div>
<div class="line">                (<span class="stringliteral">&quot;Password: &quot;</span>, full_password, <span class="keyword">sizeof</span>(full_password));</div>
<div class="line">            <span class="keywordflow">if</span> (have_password) {</div>
<div class="line">                have_password = read_password</div>
<div class="line">                    (<span class="stringliteral">&quot;Confirm Password: &quot;</span>, confirm_password,</div>
<div class="line">                     <span class="keyword">sizeof</span>(confirm_password));</div>
<div class="line">                <span class="keywordflow">if</span> (!have_password || strcmp(full_password, confirm_password) != 0) {</div>
<div class="line">                    fprintf(stderr, <span class="stringliteral">&quot;%s: passwords do not match\n&quot;</span>, progname);</div>
<div class="line">                    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(full_password, <span class="keyword">sizeof</span>(full_password));</div>
<div class="line">                    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(confirm_password, <span class="keyword">sizeof</span>(confirm_password));</div>
<div class="line">                    <span class="keywordflow">return</span> 1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (!have_password) {</div>
<div class="line">            <span class="comment">/* We don&#39;t know how to prompt for passwords, so we require that</span></div>
<div class="line"><span class="comment">             * the user supply the -p or -k option on the command-line. */</span></div>
<div class="line">            <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(full_password, <span class="keyword">sizeof</span>(full_password));</div>
<div class="line">            <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(confirm_password, <span class="keyword">sizeof</span>(confirm_password));</div>
<div class="line">            usage(progname);</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Encrypt or decrypt the supplied files */</span></div>
<div class="line">    <span class="keywordflow">for</span> (posn = optind; posn &lt; argc; ++posn) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *filename;</div>
<div class="line">        <span class="keywordflow">if</span> (!strcmp(argv[posn], <span class="stringliteral">&quot;-&quot;</span>) &amp;&amp; !opt_output) {</div>
<div class="line">            <span class="comment">/* If we are encrypting standard input and there is no output</span></div>
<div class="line"><span class="comment">             * filename given, default to writing to standard output. */</span></div>
<div class="line">            opt_output = <span class="stringliteral">&quot;-&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (opt_mode == MODE_DECRYPT) {</div>
<div class="line">            <span class="keywordflow">if</span> (opt_output)</div>
<div class="line">                filename = opt_output;</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_encrypted_filename(argv[posn]))</div>
<div class="line">                filename = strip_suffix(argv[posn]);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                filename = add_suffix(argv[posn], <span class="stringliteral">&quot;.decrypted&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (!decrypt_file(argv[posn], filename))</div>
<div class="line">                exit_val = 1;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">if</span> (opt_output)</div>
<div class="line">                filename = opt_output;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                filename = add_suffix(argv[posn], <span class="stringliteral">&quot;.ascon&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (!encrypt_file(argv[posn], filename))</div>
<div class="line">                exit_val = 1;</div>
<div class="line">        }</div>
<div class="line">        opt_output = NULL; <span class="comment">/* Can only use the -o option once */</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Clean up and exit */</span></div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(full_password, <span class="keyword">sizeof</span>(full_password));</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(confirm_password, <span class="keyword">sizeof</span>(confirm_password));</div>
<div class="line">    <span class="keywordflow">return</span> exit_val;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Print usage information for the program */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *progname)</div>
<div class="line">{</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Usage: %s [-e|-d] [-p PASSWORD | -k KEYFILE] [-o OUTPUT] INPUT ...\n&quot;</span>, progname);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;   or: %s -g KEYFILE\n&quot;</span>, progname);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;-e              Encrypt the file(s)\n&quot;</span>);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;-d              Decrypt the file(s)\n&quot;</span>);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;-p PASSWORD     Provides the password on the command-line.\n&quot;</span>);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;-k KEYFILE      Provides the password via a key file.\n&quot;</span>);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;-o OUTPUT       Output file to write to.\n&quot;</span>);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;-g KEYFILE      Generate a random password and write it to KEYFILE.\n&quot;</span>);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Print an error for a password that is too long */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> password_error(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)</div>
<div class="line">{</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;%s: password is too long, maximum is %d bytes\n&quot;</span>,</div>
<div class="line">            filename, ASCON_PWSIZ - 1);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Number of characters to put in a generated password */</span></div>
<div class="line"><span class="preprocessor">#define DEFAULT_PASSWORD_LENGTH 40</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Generates a random password and writes it to keyfile */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> generate_password(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyfile)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Uses the same ASCII encoding as https://www.aescrypt.com/ */</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span> pw_chars[] =</div>
<div class="line">        <span class="stringliteral">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ%$&quot;</span>;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> password[DEFAULT_PASSWORD_LENGTH];</div>
<div class="line">    <span class="keywordtype">unsigned</span> posn;</div>
<div class="line">    SAFEFILE file;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Try to open keyfile before we start */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!safe_file_open_write(&amp;file, keyfile))</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Generate random bytes for the password */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!<a name="a1"></a><a class="code" href="random_8h.html#a38c7ab7e9a904f53aed0446661d43646">ascon_random</a>(password, <span class="keyword">sizeof</span>(password))) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;FATAL: system random number generator does not appear to be working!\n&quot;</span>);</div>
<div class="line">        safe_file_delete(&amp;file);</div>
<div class="line">        <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(password, <span class="keyword">sizeof</span>(password));</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Reduce each byte to modulo 64 and convert into ASCII.  This will throw</span></div>
<div class="line"><span class="comment">     * away some of the bits, but any random bit is as good as any other. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (posn = 0; posn &lt; <span class="keyword">sizeof</span>(password); ++posn)</div>
<div class="line">        password[posn] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)pw_chars[password[posn] &amp; 0x3F];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Write the generated password to keyfile */</span></div>
<div class="line">    safe_file_write(&amp;file, password, <span class="keyword">sizeof</span>(password));</div>
<div class="line">    safe_file_write(&amp;file, <span class="stringliteral">&quot;\n&quot;</span>, 1);</div>
<div class="line">    safe_file_close(&amp;file);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Clean up and exit */</span></div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(password, <span class="keyword">sizeof</span>(password));</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Reads the password from a key file */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> read_keyfile(<span class="keyword">const</span> <span class="keywordtype">char</span> *keyfile)</div>
<div class="line">{</div>
<div class="line">    SAFEFILE file;</div>
<div class="line">    <span class="keywordtype">int</span> len, posn;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read the contents of the key file */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!safe_file_open_read(&amp;file, keyfile))</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    len = safe_file_read(&amp;file, full_password, <span class="keyword">sizeof</span>(full_password));</div>
<div class="line">    safe_file_close(&amp;file);</div>
<div class="line">    <span class="keywordflow">if</span> (len &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Find the end of line marker for the first line of the file */</span></div>
<div class="line">    posn = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (posn &lt; len &amp;&amp; full_password[posn] != <span class="charliteral">&#39;\n&#39;</span> &amp;&amp;</div>
<div class="line">           full_password[posn] != <span class="charliteral">&#39;\r&#39;</span>) {</div>
<div class="line">        <span class="keywordflow">if</span> (full_password[posn] == <span class="charliteral">&#39;\0&#39;</span>) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;%s: password value contains a NUL\n&quot;</span>, keyfile);</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line">        ++posn;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (posn &gt;= len &amp;&amp; len &gt;= (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(full_password)) {</div>
<div class="line">        <span class="comment">/* Could not find an end of line marker; password is too long */</span></div>
<div class="line">        password_error(keyfile);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    full_password[posn] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Determine if a filename appears to be for an encrypted file */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> is_encrypted_filename(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> len = strlen(filename);</div>
<div class="line">    <span class="keywordflow">if</span> (len &gt;= 6)</div>
<div class="line">        <span class="keywordflow">return</span> !strncmp(filename + len - 6, <span class="stringliteral">&quot;.ascon&quot;</span>, 6);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Strips the &quot;.ascon&quot; suffix from a filename */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *strip_suffix(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> len = strlen(filename) - 6;</div>
<div class="line">    <span class="keywordflow">if</span> (len &gt;= <span class="keyword">sizeof</span>(temp_filename))</div>
<div class="line">        len = <span class="keyword">sizeof</span>(temp_filename);</div>
<div class="line">    memcpy(temp_filename, filename, len);</div>
<div class="line">    temp_filename[len] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> temp_filename;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Adds a suffix to a filename */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *add_suffix(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *suffix)</div>
<div class="line">{</div>
<div class="line">    snprintf(temp_filename, <span class="keyword">sizeof</span>(temp_filename), <span class="stringliteral">&quot;%s%s&quot;</span>, filename, suffix);</div>
<div class="line">    <span class="keywordflow">return</span> temp_filename;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Bytes to be written to the header portion of the file */</span></div>
<div class="line"><span class="keyword">struct </span>asconcrypt_header</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> magic[10];             <span class="comment">/* &quot;ASCONcrypt&quot; */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> version[2];   <span class="comment">/* Version number */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> salt[16];     <span class="comment">/* Salt value */</span></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Bytes to be written to the &quot;SIV block&quot; portion of the file */</span></div>
<div class="line"><span class="keyword">struct </span>asconcrypt_siv_block</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[20];      <span class="comment">/* Key value for the payload */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> nonce[16];    <span class="comment">/* Nonce value for the payload */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tag[16];      <span class="comment">/* Tag value to authenticate the block */</span></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Header plus the &quot;SIV block&quot; */</span></div>
<div class="line"><span class="keyword">struct </span>asconcrypt_full_header</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>asconcrypt_header header;</div>
<div class="line">    <span class="keyword">struct </span>asconcrypt_siv_block siv;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Encrypts a file */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> encrypt_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *infilename, <span class="keyword">const</span> <span class="keywordtype">char</span> *outfilename)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>asconcrypt_header header;</div>
<div class="line">    <span class="keyword">struct </span>asconcrypt_siv_block siv;</div>
<div class="line">    <span class="keyword">struct </span>asconcrypt_siv_block siv_copy;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> kn[20 + 16];</div>
<div class="line">    <span class="keywordtype">int</span> exit_val = 0;</div>
<div class="line">    <span class="keywordtype">size_t</span> clen = 0;</div>
<div class="line">    SAFEFILE input;</div>
<div class="line">    SAFEFILE output;</div>
<div class="line">    <a name="_a2"></a><a class="code" href="structascon80pq__state__t.html">ascon80pq_state_t</a> state;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[ASCON_BUFSIZ];</div>
<div class="line">    uint64_t size;</div>
<div class="line">    <span class="keywordtype">int</span> len;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Open the input and output files.  If we can&#39;t do this then</span></div>
<div class="line"><span class="comment">     * there is nothing we can do - bail out. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!safe_file_open_read(&amp;input, infilename)) {</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!safe_file_open_write(&amp;output, outfilename)) {</div>
<div class="line">        safe_file_close(&amp;input);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Format the header */</span></div>
<div class="line">    memcpy(header.magic, <span class="stringliteral">&quot;ASCONcrypt&quot;</span>, 10);</div>
<div class="line">    header.version[0] = 0;</div>
<div class="line">    header.version[1] = 1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate the salt, key, and nonce randomly */</span></div>
<div class="line">    memset(&amp;siv, 0, <span class="keyword">sizeof</span>(siv));</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="random_8h.html#a38c7ab7e9a904f53aed0446661d43646">ascon_random</a>(header.salt, <span class="keyword">sizeof</span>(header.salt)) ||</div>
<div class="line">            !<a class="code" href="random_8h.html#a38c7ab7e9a904f53aed0446661d43646">ascon_random</a>(siv.key, <span class="keyword">sizeof</span>(siv.key) + <span class="keyword">sizeof</span>(siv.nonce))) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;FATAL: system random number generator does not appear to be working!\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line">    siv_copy = siv;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Run PBKDF2 to derive the key and nonce to use to encrypt the SIV block */</span></div>
<div class="line">    <a name="a3"></a><a class="code" href="pbkdf2_8h.html#a9f535b04717852cdae5f2f7ba0a99fd0">ascon_pbkdf2</a>(kn, <span class="keyword">sizeof</span>(kn),</div>
<div class="line">                 (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)full_password, strlen(full_password),</div>
<div class="line">                 header.salt, <span class="keyword">sizeof</span>(header.salt), ASCON_PBKDF2_ROUNDS);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Encrypt the SIV block and generate the tag */</span></div>
<div class="line">    <a name="a4"></a><a class="code" href="siv_8h.html#a6085aa447e6af78f5c6f347d000e8bc8">ascon80pq_siv_encrypt</a></div>
<div class="line">        (siv.key, &amp;clen, siv.key, <span class="keyword">sizeof</span>(siv.key) + <span class="keyword">sizeof</span>(siv.nonce),</div>
<div class="line">         (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;header, <span class="keyword">sizeof</span>(header), kn + 20, kn);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Write the header and SIV block to the output file */</span></div>
<div class="line">    exit_val = 1;</div>
<div class="line">    <span class="keywordflow">if</span> (!safe_file_write(&amp;output, &amp;header, <span class="keyword">sizeof</span>(header)) ||</div>
<div class="line">            !safe_file_write(&amp;output, &amp;siv, <span class="keyword">sizeof</span>(siv))) {</div>
<div class="line">        exit_val = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read the input file, encrypt it, and write to the output file */</span></div>
<div class="line">    <a name="a5"></a><a class="code" href="aead_8h.html#a4a0a167ac1c5bb4b978d5a1f2144681a">ascon80pq_aead_start</a></div>
<div class="line">        (&amp;state, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;siv, <span class="keyword">sizeof</span>(siv),</div>
<div class="line">         siv_copy.nonce, siv_copy.<a name="a6"></a><a class="code" href="structascon80pq__state__t.html#a9426fe2207d4ea501e5b664fd106ab68">key</a>);</div>
<div class="line">    size = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (exit_val) {</div>
<div class="line">        len = safe_file_read(&amp;input, data, <span class="keyword">sizeof</span>(data));</div>
<div class="line">        <span class="keywordflow">if</span> (len &lt; 0) {</div>
<div class="line">            exit_val = 0;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len == 0) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            size += (unsigned)len;</div>
<div class="line">            <span class="keywordflow">if</span> (size &gt; ASCON_MAX_FILE_SIZE) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: maximum file size exceeded\n&quot;</span>, infilename);</div>
<div class="line">                exit_val = 0;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <a name="a7"></a><a class="code" href="aead_8h.html#a71bdab88f3fb8be929d92a7e70e3ae60">ascon80pq_aead_encrypt_block</a>(&amp;state, data, data, len);</div>
<div class="line">            <span class="keywordflow">if</span> (!safe_file_write(&amp;output, data, len))</div>
<div class="line">                exit_val = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (len &lt; (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(data))</div>
<div class="line">                <span class="keywordflow">break</span>; <span class="comment">/* Short last block - we&#39;re done */</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <a name="a8"></a><a class="code" href="aead_8h.html#a9e2dc4423fcbc2695e56cde5c2742c1e">ascon80pq_aead_encrypt_finalize</a>(&amp;state, data);</div>
<div class="line">    <span class="keywordflow">if</span> (exit_val) {</div>
<div class="line">        <span class="keywordflow">if</span> (!safe_file_write(&amp;output, data, <a name="a9"></a><a class="code" href="aead_8h.html#a450d7deb3267a5767c2792fb32bdc912">ASCON80PQ_TAG_SIZE</a>))</div>
<div class="line">            exit_val = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">cleanup:</div>
<div class="line">    <span class="comment">/* Clean up and exit */</span></div>
<div class="line">    safe_file_close(&amp;input);</div>
<div class="line">    safe_file_close(&amp;output);</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(&amp;header, <span class="keyword">sizeof</span>(header));</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(&amp;siv, <span class="keyword">sizeof</span>(siv));</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(&amp;siv_copy, <span class="keyword">sizeof</span>(siv_copy));</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(kn, <span class="keyword">sizeof</span>(kn));</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(data, <span class="keyword">sizeof</span>(data));</div>
<div class="line">    <span class="keywordflow">if</span> (!exit_val)</div>
<div class="line">        safe_file_delete(&amp;output);</div>
<div class="line">    <span class="keywordflow">return</span> exit_val;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Decrypt a file */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> decrypt_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *infilename, <span class="keyword">const</span> <span class="keywordtype">char</span> *outfilename)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>asconcrypt_full_header header;</div>
<div class="line">    <span class="keyword">struct </span>asconcrypt_siv_block siv_copy;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> kn[20 + 16];</div>
<div class="line">    <span class="keywordtype">int</span> exit_val = 0;</div>
<div class="line">    <span class="keywordtype">size_t</span> mlen = 0;</div>
<div class="line">    <span class="keywordtype">int</span> bad_format;</div>
<div class="line">    SAFEFILE input;</div>
<div class="line">    SAFEFILE output;</div>
<div class="line">    <a class="code" href="structascon80pq__state__t.html">ascon80pq_state_t</a> state;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[ASCON_BUFSIZ];</div>
<div class="line">    uint64_t size;</div>
<div class="line">    <span class="keywordtype">int</span> len;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Open the input and output files.  If we can&#39;t do this then</span></div>
<div class="line"><span class="comment">     * there is nothing we can do - bail out. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!safe_file_open_read(&amp;input, infilename)) {</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!safe_file_open_write(&amp;output, outfilename)) {</div>
<div class="line">        safe_file_close(&amp;input);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read and validate the file&#39;s header */</span></div>
<div class="line">    bad_format = 0;</div>
<div class="line">    <span class="keywordflow">if</span> (safe_file_read(&amp;input, &amp;header, <span class="keyword">sizeof</span>(header)) != (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(header)) {</div>
<div class="line">        bad_format = 1;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">if</span> (memcmp(header.header.magic, <span class="stringliteral">&quot;ASCONcrypt&quot;</span>, 10) != 0 ||</div>
<div class="line">                header.header.version[0] != 0 ||</div>
<div class="line">                header.header.version[1] != 1) {</div>
<div class="line">            bad_format = 1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (bad_format) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;%s: unrecognized encrypted file format\n&quot;</span>,</div>
<div class="line">                infilename);</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Run PBKDF2 to derive the key and nonce to use to decrypt the SIV block */</span></div>
<div class="line">    <a class="code" href="pbkdf2_8h.html#a9f535b04717852cdae5f2f7ba0a99fd0">ascon_pbkdf2</a>(kn, <span class="keyword">sizeof</span>(kn),</div>
<div class="line">                 (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)full_password, strlen(full_password),</div>
<div class="line">                 header.header.salt, <span class="keyword">sizeof</span>(header.header.salt),</div>
<div class="line">                 ASCON_PBKDF2_ROUNDS);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Decrypt the SIV block and check the tag */</span></div>
<div class="line">    siv_copy = header.siv;</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a10"></a><a class="code" href="siv_8h.html#a79504dacdfd41b127c78dcf8a6862eea">ascon80pq_siv_decrypt</a></div>
<div class="line">            (header.siv.key, &amp;mlen, header.siv.key, <span class="keyword">sizeof</span>(header.siv),</div>
<div class="line">             (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;(header.header), <span class="keyword">sizeof</span>(header.header),</div>
<div class="line">             kn + 20, kn) != 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;%s: password is incorrect\n&quot;</span>, infilename);</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* We need to decrypt everything except the last 16 bytes which is the</span></div>
<div class="line"><span class="comment">     * authentication tag.  Pre-read the first 16 bytes and then keep 16</span></div>
<div class="line"><span class="comment">     * bytes in the buffer for every block until we are done. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (safe_file_read(&amp;input, data, 16) != 16) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;%s: encrypted data is truncated\n&quot;</span>, infilename);</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read the input file, decrypt it, and write to the output file */</span></div>
<div class="line">    <a class="code" href="aead_8h.html#a4a0a167ac1c5bb4b978d5a1f2144681a">ascon80pq_aead_start</a></div>
<div class="line">        (&amp;state, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;siv_copy, <span class="keyword">sizeof</span>(siv_copy),</div>
<div class="line">         header.siv.nonce, header.siv.<a class="code" href="structascon80pq__state__t.html#a9426fe2207d4ea501e5b664fd106ab68">key</a>);</div>
<div class="line">    size = 0;</div>
<div class="line">    exit_val = 1;</div>
<div class="line">    <span class="keywordflow">while</span> (exit_val) {</div>
<div class="line">        len = safe_file_read(&amp;input, data + 16, <span class="keyword">sizeof</span>(data) - 16);</div>
<div class="line">        <span class="keywordflow">if</span> (len &lt; 0) {</div>
<div class="line">            exit_val = 0;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len == 0) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            size += (unsigned)len;</div>
<div class="line">            <span class="keywordflow">if</span> (size &gt; ASCON_MAX_FILE_SIZE) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: maximum file size exceeded\n&quot;</span>, infilename);</div>
<div class="line">                exit_val = 0;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <a name="a11"></a><a class="code" href="aead_8h.html#a923a2b71d9f02499d70b481f45c6c9e4">ascon80pq_aead_decrypt_block</a>(&amp;state, data, data, len);</div>
<div class="line">            <span class="keywordflow">if</span> (!safe_file_write(&amp;output, data, len))</div>
<div class="line">                exit_val = 0;</div>
<div class="line">            memmove(data, data + len, 16);</div>
<div class="line">            <span class="keywordflow">if</span> (len &lt; (<span class="keywordtype">int</span>)(<span class="keyword">sizeof</span>(data) - 16))</div>
<div class="line">                <span class="keywordflow">break</span>; <span class="comment">/* Short last block - we&#39;re done */</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a12"></a><a class="code" href="aead_8h.html#af70beb05e74919600dfaef51478bfd28">ascon80pq_aead_decrypt_finalize</a>(&amp;state, data) != 0 &amp;&amp; exit_val) {</div>
<div class="line">        exit_val = 0;</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;%s: file is corrupt and failed to decrypt\n&quot;</span>,</div>
<div class="line">                infilename);</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">cleanup:</div>
<div class="line">    <span class="comment">/* Clean up and exit */</span></div>
<div class="line">    safe_file_close(&amp;input);</div>
<div class="line">    safe_file_close(&amp;output);</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(&amp;header, <span class="keyword">sizeof</span>(header));</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(&amp;siv_copy, <span class="keyword">sizeof</span>(siv_copy));</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(kn, <span class="keyword">sizeof</span>(kn));</div>
<div class="line">    <a class="code" href="utility_8h.html#a331ff039487fd153ee170a600cf4850b">ascon_clean</a>(data, <span class="keyword">sizeof</span>(data));</div>
<div class="line">    <span class="keywordflow">if</span> (!exit_val)</div>
<div class="line">        safe_file_delete(&amp;output);</div>
<div class="line">    <span class="keywordflow">return</span> exit_val;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue May 3 2022 16:33:52 for ASCON Suite by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
